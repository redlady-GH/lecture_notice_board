# [학습자료] 웹 보안 기초: CSRF 공격과 방어

이 문서는 프로젝트의 **게시글 삭제 기능**에서 발견된 보안 취약점을 분석하고, 이를 해결하는 과정을 통해 **CSRF(Cross-Site Request Forgery)** 공격의 원리와 방어 방법을 학습하기 위한 자료입니다.

## 1. 문제 상황: "링크만 눌렀는데 삭제가 된다고?"

초기 개발 단계에서 우리는 게시글 삭제를 다음과 같이 구현했습니다.

*   **HTML**: `<a href="/delete/3">삭제</a>` (하이퍼링크)
*   **Server**: `@app.route('/delete/<int:id>')` (GET 요청 처리)

### 1.1. 무엇이 문제인가요?
HTTP 표준에서 **GET** 메서드는 데이터를 **조회**할 때만 사용해야 합니다. 서버의 상태를 변경(삭제, 수정)하는 작업에 GET을 사용하면 다음과 같은 심각한 보안 문제가 발생합니다.

1.  **CSRF 공격에 매우 취약함**: 공격자가 관리자에게 이메일로 `<img src="http://myserver.local/delete/5">` 태그를 보내면, 관리자가 이메일을 열기만 해도 브라우저는 이미지를 불러오기 위해 해당 URL로 요청을 보냅니다. 그 결과, **관리자도 모르게 5번 게시글이 삭제**됩니다.
2.  **웹 크롤러의 오작동**: 검색엔진 봇이나 브라우저의 '미리 읽기' 기능이 페이지 내의 모든 링크를 방문하다가 게시글을 전부 삭제해버릴 수 있습니다.

---

## 2. 해결책 1단계: POST 메서드와 수동 토큰 검증 (Level 1)

이 문제를 해결하기 위해 `app.py`에서는 두 가지 안전장치를 도입했습니다.

### 2.1. POST 메서드로 전환
먼저, 삭제 요청을 `GET`에서 `POST`로 변경했습니다. 이제 `<a>` 태그나 `<img>` 태그로는 삭제 요청을 보낼 수 없으며, 반드시 `<form>`을 통해서만 가능합니다.

### 2.2. CSRF Token 도입 (수동 구현)
하지만 POST로 바꿔도 공격자가 가짜 폼(Form)을 만들어 전송할 수 있습니다. 이를 막기 위해 **"우리 사이트에서 만든 폼이 맞는지"** 확인하는 표식(Token)이 필요합니다.

**구현 원리 (`app.py`):**
1.  **토큰 생성**: 서버는 난수(Random Hex)를 만들어 사용자 세션(`session['csrf_token']`)에 저장합니다.
2.  **토큰 전달**: HTML 폼을 보여줄 때, 이 난수를 `hidden input`으로 몰래 넣어둡니다.
3.  **토큰 검증**: 사용자가 삭제 버튼을 누르면, 서버는 **세션에 있는 값**과 **폼에서 넘어온 값**이 일치하는지 확인합니다.

```python
# app.py 예시
token = request.form.get('csrf_token')
if not token or token != session.get('csrf_token'):
    abort(403) # 검증 실패 시 403 에러
```

---

## 3. 해결책 2단계: Flask-WTF 라이브러리 사용 (Level 2)

실무에서는 개발자가 매번 토큰 생성/검증 로직을 짜는 것이 번거롭고 실수하기 쉽습니다. 그래서 표준 라이브러리인 **Flask-WTF**를 사용합니다.

**구현 원리 (`app_WTF.py`):**
1.  **설정**: `CSRFProtect(app)` 한 줄로 모든 POST 요청에 대한 보호를 활성화합니다.
2.  **템플릿**: HTML 폼 안에 `{{ csrf_token() }}`만 넣어주면 라이브러리가 알아서 토큰을 생성하고 삽입합니다.
3.  **검증**: 서버 코드에서 별도의 `if` 문을 작성할 필요가 없습니다. 라이브러리가 요청이 들어오기 전에 자동으로 검증하고, 틀리면 **400 Bad Request** 에러를 냅니다.

---

## 4. 요약 및 결론

| 구분 | 초기 버전 (취약) | Level 1 (app.py) | Level 2 (app_WTF.py) |
| :--- | :--- | :--- | :--- |
| **HTTP Method** | GET | POST | POST |
| **CSRF 방어** | 없음 | 수동 구현 (난수 생성) | **Flask-WTF (자동)** |
| **보안 수준** | ❌ 위험 | ✅ 안전 | ✅ 안전 + 편리 |

보안은 "기능이 동작하는가"를 넘어 "**의도하지 않은 동작을 막을 수 있는가**"를 고민하는 것입니다.
이번 실습을 통해 **HTTP Method의 올바른 사용**과 **CSRF 방어의 중요성**을 꼭 기억하시기 바랍니다.
