# [학습자료] 웹 보안 기초: 세션 탈취(Session Hijacking)와 방어

이 문서는 웹 애플리케이션에서 가장 흔하고 위험한 공격 중 하나인 **세션 탈취**(Session Hijacking)의 원리를 이해하고, 우리 프로젝트(`app.py`)에 적용된 방어 기술을 학습하기 위한 자료입니다.

## 1. 세션 탈취란 무엇인가요?

### 1.1. 놀이공원 자유이용권 비유
웹 사이트의 **세션(Session)**(Session)은 놀이공원의 **자유이용권 팔찌**와 같습니다.
*   입구에서 표를 사면(로그인), 직원이 팔찌를 채워줍니다(세션 쿠키 발급).
*   놀이기구를 탈 때마다(페이지 이동), 직원은 팔찌만 확인합니다(쿠키 검증).
*   **세션 탈취**는 나쁜 사람이 **내 팔찌를 훔쳐서 내 행세**를 하는 것입니다. 비밀번호를 몰라도, 팔찌만 있으면 내가 됩니다.

---

## 2. 어떻게 탈취하나요? (주요 공격 시나리오)

### ① 네트워크 감청 (Sniffing)
*   **상황**: 카페 와이파이 같은 공용 네트워크를 사용 중입니다.
*   **공격**: 사용자가 `http://` (암호화되지 않은 통신)로 접속하면, 같은 와이파이를 쓰는 해커가 공중을 날아다니는 패킷을 낚아채서 쿠키 값을 읽어냅니다.
*   **비유**: 투명한 봉투에 팔찌를 넣어서 직원에게 건네주는 것과 같습니다. 옆사람이 다 볼 수 있습니다.

### ② XSS (Cross-Site Scripting)
*   **상황**: 게시판에 해커가 악성 스크립트(`<script>...`)를 몰래 심어놓았습니다.
*   **공격**: 일반 사용자가 그 글을 읽는 순간, 자바스크립트가 실행되어 `document.cookie` 명령어로 쿠키 값을 해커의 서버로 전송합니다.
*   **비유**: "이 글 좀 봐주세요"라고 해서 갔더니, 내 팔찌를 복사해가는 몰래카메라가 설치된 격입니다.

---

## 3. 우리 프로젝트의 방어 전략

이 프로젝트는 이러한 공격을 막기 위해 **인프라**(Nginx)와 **애플리케이션**(Flask) 양쪽에서 방어막을 구축했습니다.

### 3.1. 인프라 레벨: HTTPS 적용 (Sniffing 방지)
`http://` 대신 `https://`를 사용하면 모든 통신이 암호화됩니다. 해커가 패킷을 가로채도 암호화된 난수만 보일 뿐, 실제 쿠키 값은 알 수 없습니다.
*   **구현**: Nginx 리버스 프록시에서 SSL 인증서를 적용하여 처리합니다. (실무 배포 시 필수)

### 3.2. 애플리케이션 레벨: 쿠키 보안 설정 (XSS 방지)
`app.py`를 보면 다음과 같은 보안 설정이 적용되어 있습니다.

```python
# app.py
app.config['SESSION_COOKIE_HTTPONLY'] = True  # 핵심 방어
app.config['SESSION_COOKIE_SECURE'] = True
app.config['SESSION_COOKIE_SAMESITE'] = 'Lax'
```

#### ① `SESSION_COOKIE_HTTPONLY = True`
*   **의미**: "이 쿠키는 HTTP 통신(서버 전송)에만 쓰고, **자바스크립트로는 접근하지 마라**"는 뜻입니다.
*   **효과**: 해커가 XSS 공격에 성공해서 자바스크립트를 실행시켜도, `document.cookie`로 세션 값을 읽을 수 없습니다. (빈 값만 나옵니다.)

#### ② `SESSION_COOKIE_SECURE = True`
*   **의미**: "이 쿠키는 **HTTPS** 연결일 때만 전송해라"는 뜻입니다.
*   **효과**: 실수로 `http://`로 접속하더라도, 브라우저가 쿠키를 보내지 않아 세션이 노출되지 않습니다.

#### ③ `SESSION_COOKIE_SAMESITE = 'Lax'`
*   **의미**: 외부 사이트에서 우리 사이트로 링크를 타고 들어올 때 쿠키 전송 정책을 제어합니다.
*   **효과**: CSRF 공격을 어느 정도 방어하는 효과가 있습니다.

---

## 4. 개발 시 주의사항 (XSS 예방)

Flask의 템플릿 엔진(Jinja2)은 기본적으로 모든 입력을 **이스케이프(Escape)** 처리합니다. 즉, `<script>` 태그를 입력해도 화면에는 글자 그대로 `<script>`라고 나올 뿐 실행되지 않습니다.

하지만 개발자가 편의를 위해 `| safe` 필터를 사용하면 이 보호막이 해제됩니다.

**❌ 위험한 코드:**
```html
<!-- 사용자가 쓴 글을 믿고 그대로 실행함 (절대 금지) -->
{{ post.content | safe }}
```

**✅ 안전한 코드 (현재 프로젝트):**
```html
<!-- 태그가 문자로 변환되어 출력됨 -->
<pre>{{ post.content }}</pre>
```

## 5. 요약

| 공격 유형 | 방어 기술 | 원리 |
| :--- | :--- | :--- |
| **Sniffing (감청)** | **HTTPS + Secure Cookie** | 통신을 암호화하고, 암호화된 채널에서만 쿠키 전송 |
| **XSS (스크립트)** | **HttpOnly Cookie** | 자바스크립트가 쿠키에 접근하지 못하도록 차단 |
| **XSS (스크립트)** | **Auto Escape** | 사용자 입력값의 실행 권한 박탈 (`| safe` 사용 금지) |

보안은 하나의 기술로 완성되지 않습니다. **서버 설정**(HTTPS)과 **코드 설정**(Cookie Option)이 조화를 이뤄야 안전한 서비스를 만들 수 있습니다.
